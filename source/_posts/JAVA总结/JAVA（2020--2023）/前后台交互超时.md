---
title: 前后台交互超时
date: 2020.12.25
tag: JAVA
categories:
  - JAVA总结
  - JAVA（2020--2023）
---

# 文件上传超时

# Input

大家注意到这次请求的总共耗时15.34s，而其中Request Sent耗时9.87s，Waiting耗时5.46s，Content Download耗时6.20ms，

Request Sent可以简单理解为浏览器端将所有**请求**数据（表单参数、文件）**传输**到服务器的时间，

Wating为服务器收到前端浏览器提交的数据后进行**处理**的时间，

Content Download为服务器返回**响应**到浏览器的**传输**时间，

![img](https://img-blog.csdnimg.cn/20190916115439176.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x1bzE1MjQyMjA4MzEw,size_16,color_FFFFFF,t_70)

## 1.后台处理超时

 项目中有个从页面发起的AJAX请求后台需要处理十分钟以上，这导致页面超时卡死

为了解决这个问题，经讨论，我们采用后台异步处理，用到了spring的@Async，用法很简单。

首先在spring的xml配置文件中添加如下配置：

```html
xmlns:task="http://www.springframework.org/schema/task"
http://www.springframework.org/schema/task
http://www.springframework.org/schema/task/spring-task-4.0.xsd">
<task:annotation-driven />															
```

其次在需要异步执行的方法上添加@Async注解即可：

```java
package async;
import java.util.HashMap;
import java.util.Map;
import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
@Controller
public class MyController {
	@Resource
	MyService myService;
	@RequestMapping("/testAsync.do")
	@ResponseBody
	public Map<String, Object> testAsync(HttpServletRequest req){
		Map<String, Object> resultMap = new HashMap<String, Object>();
		String param = req.getParameter("param");
	//调用异步执行的方法
		myService.excuteAsync(param);
		resultMap.put("resultMsg", "异步处理中...");
		return resultMap;
	}
}
```

```java
package async;
import org.springframework.scheduling.annotation.Async;
public class MyService {
	//需要异步处理的业务方法
	@Async
	public void excuteAsync(String param){
		// do something;
	}
}
```



页面超时的问题解决了，但是异步方法什么时候执行完，

操作人员如果想知道进度或第一时间知道执行结果怎么办呢？

目前想到了三种解决方法：

一、异步方法执行完后，发送邮件给操作人；

二、实时查询后台执行的进度显示在页面；

三、异步方法执行完后，再在页面给一个提示。

我们采用的是第一种，至于每一种的具体实现，这里就不详述了。

![img](https://img-blog.csdn.net/20170927203727742?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2luYXRfMzczNTYwNjQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

## 2.上传文件超时

[待验证]在上传文件过程中由于网速比较慢可能会屡次出现下列问题: org.apache.commons.fileupload.FileUploadBase$IOFileUploadException: Processing of multipart/form-data request failed. Read timed out
很明显，出现这种问题的原因是读取文件超时，解决方法是将HTTP Keep-Alive Timeout这个参数设置地尽量大。如果使用tomcat做服务器的话，我们可以通过修改服务器配置来解决该问题，具体的解决方法如下：
修改tomcat的配置文件conf/server.xml，找到下面配置信息:

> maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
> enableLookups="false" redirectPort="8443" acceptCount="100"
> connectionTimeout="20000" disableUploadTimeout="true" />
> 我们只需要将上面的参数disableUploadTimeout值改为false即可。