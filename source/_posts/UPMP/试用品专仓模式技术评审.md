---
title: 试用品专仓模式技术评审
categories:
  - UPMP
tag: '评审,专仓'
date: 2020-12-02 00:00:00
---
# 试用品专仓模式技术评审

## 1. 活动管理

### 1.1 审核处维护仓库模式

> 前端：审核界面处增加，查看活动带出（话卡活动，存量活动可展示为同仓模式）
>
> **后台：维护至活动参数列表（默认contract组，warehouseType：0为同仓，1为专仓**）
>
> 活动表维护**warehouse_type**字段（-1默认，0同仓，1专仓）可用于判断是否第一次维护，从而前端是否可编辑

### 1.2 排序

> 增加仓库模式列，若为话卡活动时，此列内容置空。
>
> 排序标准无变化。
>

### 1.3 活动开启

> 校验活动的仓库类型，若为专仓不去锁库存。
>
> **startActivityCheckById：原根据SKU去查询的库存量，根据专仓ID过滤出专仓库存信息**
>
> **startActivityWithWarehouseDistById，去锁库存操作，专仓模式跳过。**
>
> **startActivityWithPinPackage 圈选人群，1不圈，2圈。不涉及。**
>
> ==注意：==
>
> 增加指定渠道库存量查询，比较库存可用量和指定渠道库存量最小值。作为开启库存量。

### 1.4 活动结束

> 终止活动以及活动结束（提前发完/活动14天后禁止顺延）不释放库存
>
> **后台：释放库存处，判断仓库类型**

### 1.5 DUCC配置专仓管理

> 配送覆盖范围和众邮打印信息
>
> 寄件人信息
>
> 初始化数据：
>
> 专仓配送覆盖范围屏蔽新疆【31】、西藏【26】、青海【29】、甘肃【28】、内蒙古【11】、宁夏【30】、海南【23】这七个一级地址以*及港澳台【42,43,32】和海外地区*，其他大陆地址均能配送。
>
> 

==活动维护仓库模式字段。==放置本地缓存中，方便存取使用。

## 2.匹配流程

### 2.1 申明点

1. 专仓下单之后需在JMQ试用品匹配和JSF话卡匹配开启前按照sendPay（261-262为41）去过滤专仓订单。

2. ducc配置仓库模式匹配优先级

3. 仓库匹配优先情况，根据仓库模式去重新排序活动优先级。

4. 原订单若匹配到专仓试用品，可继续匹配话卡以及物流广告。

   专仓订单不可进行任何活动匹配。

   ![image-20201228223842481](https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20201228223842481.png)
   
   


### 2.2 下单失败：

> 1.接口返回因为库存不足生成订单失败，则触发邮件提醒该活动的平台运营，邮件发送；
>
> **通用下单会校验指定仓库存，若无货抛异常信息 “submitOrder"|"zzqi8"|"提交异常"|[{"message":"编号为72340585957的商品无货","”   -->  后台校验只能捕捉异常校验=="商品无货"==关键字"**
>
> **邮件5分钟最多一次发送**
>
> 2.其他场景暂时记录失败时间和失败原因，定期分析后进行系统处理优化，写入OSS云存储文件中（upmp-temp(bucket)submitOrder/下）。

### 2.3 面单库存校验：

阿尔法系统 [ 商家单号库存查询](https://cf.jd.com/pages/viewpage.action?pageId=76076126)

## 3.专仓订单转态以及展示

### 3.1 正向流程

#### 3.1.0 匹配专仓订单

#### 3.1.1出库（New）

接入ODC_OUTSTOCK_FULL消息，出库之后只进行订单状态变更。

![image-20201228223920502](https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20201228223920502.png)

#### 3.1.2 用户触达

短信，文案不一致

**注意：下单成功发送短信之后，若订单被拉回之后，触发病单短信（短信接口要求一分钟内不允许收件人多次）--需要起延时woker**

Push无变化。

 **订单详情页展示**

专仓订单活动可展示至详情页，**无变化，因为专仓订单下单成功也会存入缓存中**

![image-20201224162515180](https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20201224162515180.png)

#### 3.1.3 面单信息提供

调用大头笔信息，与入参组织之后，上传至wms的jfs系统

返回相应结果。

### 3.2逆向流程

#### 3.2.1用户手动取消，ODC_CANCEL消息。

**取消消息对于专仓订单来说，不仅是用户手动取消订单时发送消息，拉回之后若调用快退接口成功也会发送取消消息**

![image-20201228223942731](https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20201228223942731.png)

#### 3.2.2 OFC拉回之后调用快退接口

![image-20201228224356899](https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20201228224356899.png)

## 4. 外部系统相关资料

### 4.1 通用下单需要信息

1. **身份信息**

   > SystemInfo
   >
   > ExtendInfoParam

2. **商品信息**

   > 商品SKU
   >
   > 商品名称 ##必填##
   
3. **用户地址信息**

   > 一级 二级 三级地址  **详细地址**
   >
   > 组机构号
   >
   > **收货人姓名 **
   >
   > 手机号

4. **配送信息**

   > 指定仓 配送中心
   >
   > 面单信息

> * 用户pin
> * orderGuid //下单唯一标识(jsf_upmp2_orderId)

忽略列表：[1,5,7,9,17][忽略列表CF](https://cf.jd.com/pages/viewpage.action?pageId=76557825)

```
businessType: 100869
```

### 4.2.阿尔法系统

#### 4.2.1 库存校验

[alpha库存面单校验](https://cf.jd.com/pages/viewpage.action?pageId=76076126)

com.jd.ldop.alpha.waybill.api.StockQueryApi#customerStockQuery

#### 4.2.2 获取大头笔信息

[大头笔信息查询接口](https://cf.jd.com/pages/viewpage.action?pageId=287588762)

```
com.jd.ldop.alpha.waybill.api.WaybillBigShotApi#queryBigShotMessage
```

### 4.3 快退系统

#### 4.3.1 OFC 拉回消息（New） ，Wmsresplit_poc

> {"key":"Wmsresplit_poc","operateCode":3,"operateTime":"2020-12-14 00:03:41","orderId":139786227302}

#### 4.3.2 快退接口

1. 接口

   [取消校验服务接口](https://cf.jd.com/pages/viewpage.action?pageId=113129521)

   > ```java
   > com.jd.fce.orb.service.OrbOrderCancelService.isApplyOrderBySource(orderId, source);
   > ```

2. 接口

   [快退取消接口](https://cf.jd.com/pages/viewpage.action?pageId=113128997)

   > ```java
   > com.jd.fce.orb.service.OrbCancelOrderService.cancelOrder(cancelRequest);
   > ```

3. 接口结果消息

   > orbCancelResult
   >
   > [结果消息](https://cf.jd.com/pages/viewpage.action?pageId=404962814)
   
4. [快退试用品文档](https://cf.jd.com/pages/viewpage.action?pageId=388767167)

5.  快退申请的取消码

   > 929 试用品仓库无货；
### 4.4 众邮大头笔信息查询

为是否支持配送范围 [众邮面单查询接口](https://cf.jd.com/pages/viewpage.action?pageId=287588762)

```
com.zhongyouex.order.api.order.findBigShotByAddressOrWaybillCode
```

### 4.5 WMS面单集群地址

> 集群地址:
>
> 172.22.212.80:2181,172.22.212.81:2181,172.22.212.82:2181,172.16.190.108:2181,172.16.190.109:2181

## 5.其他信息

### 5.1专仓信息

> 机构号：709
>  配送中心号：5
>  仓库号：130

### 5.2库存中台

试用品专仓渠道编号：19

分配指定类型specificType=28

> 因此试用品系统调用通用下单接口生成专仓订单时，需要从指定的专仓仓库发货，具体库存选项如下：
>
> 1、可售库存状态：现货
>  2、大仓覆盖范围校验：否
>  3、指定类型：指定仓
>  4、是否使用异地仓：否 
>  5、是否支持转移：是
>  6、支持不校验库存：否
>  7、拆单操作库存项：是
>  8、支持不预占库存：否

### 5.3 通用下单

> 测试订单号：**139549621679**  
>
> 140337966699

## 6.交互系统统计

涉及系统：

原有 订单中间件 短信接口  取消消息 OSS文件存储等不在叙述

- 调用： 
  1. 通用下单接口
  2. 阿尔法面单库存校验接口
  3. 阿尔法大头笔信息接口
  4. 快退2个接口
  5. 新接入 订单中台出库消息
  6. OFC拉回消息
  7. 快退取消订单结果消息
- 提供服务：
  1. OFC调用面单信息接口 （涉及JFS文件系统）

## 7.测试评审

> 1.开始活动时查询库存，能否查询指定渠道号
>
> 2.加147=3 过滤  出库、过滤、
>
> 3.下单前查看取消缓存
>
> 4.查看落库 取消消息是否影响

## 8.补充

### 8.1DB

**增加两字段**

```sql
alter table activity add  warehouse_type tinyint(4) default -1 comment '活动对应的仓库模式(-1为初始值0为同仓，1为专仓)';

alter table order_record add ref_order_id bigint(20) default null comment '专仓订单引用原订单号'; 
```

### 8.2 redis

 get v001_pin_${pin}   试用品活动参与，当日过期

 get v001_pin2_${pin}   专仓活动参与，当日过期

 get v001_activityPin_activityId_${pin}

get v001_orderIdActivityId120Day_141624423050

## 9.联调测试

1.wms--京喜快递--OFC 测试以下几种状态，是否均正常。同时前台界面会有相应线上

144609681833 ---订单在途分拣发货
144609328362 ---订单已签收
144545842511 ---已弃货：拒收/自提柜拒收 
144605552480 --- 已退件:拒收/自提柜拒收 
144603502595 ---仓无货拉回 
144610636423 ---用户出库前已取消