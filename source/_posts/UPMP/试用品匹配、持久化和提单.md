---
categories:
  - UPMP
---
# 试用品匹配、持久化和提单

## 1.总原则

* 活动相关

1. 试用品目前派发类型有试用品类型（包括虚拟品）、话卡类型
2. 试用品领取模式包括 被动派发（包括九宫格）、主动领取（目前促销母婴，校园虚拟组套）
3. 试用品渠道类型包括 0 通用渠道，1 母婴主动， 2.九宫格，3 校园渠道
4. 试用品仓库模式包括 0 同仓模式，1专仓模式 ，2虚拟仓模式

* 匹配相关

  1.  用户单日可参与 一次同仓试用品  或者 一次专仓试用品（可以带走话卡）或者 一次话卡

     另外虚拟品 和 物流和他们并列可一并参与

  2. 用户相关的pin 

     > ```java
     > // 1.移除拆单匹配key
     > String preMatchTrial = RemoteCacheKey.preMatchTrial(pin, activity.getSendType());
     > redisWrapper.remove(preMatchTrial);
     > // 2.移除今日匹配key
     > String pinKey = RemoteCacheKey.pinKey(pin);
     > redisWrapper.remove(pinKey);
     > // 3.移除活动和pin的绑定key
     > remoteCacheService.removeActivityPin(activityId, pin);
     > // 4. 还有专仓话卡那个 v001_pin2
     > 
     > ```
     
  3. 
  
  4. 
  
  5. 
  
## 2.其他记录

1.  父单匹配问题未搞定
2. 拆单问题解决使用同步锁但后续失败会导致今日用户无法再次参与。

​     