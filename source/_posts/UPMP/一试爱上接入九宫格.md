---
categories:
  - UPMP
---
# 九宫格

## 1.技术方案涉及范围

* 试用品侧二级缓存维护按渠道类型筛选活动列表
* 通用下单中台能力
* 试用品中台提供C端用户领取试用品功能
* 参与九宫格活动的父订单与下传至OFC的子订单同步进入试用品系统匹配多件问题（同拆单问题）

## 2.详细设计

### 2.1 一试爱上接入九宫格系统交互图

<img src="https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20210726150937832.png" alt="image-20210726150937832" style="zoom:70%;" />

### 2.2 试用品接入九宫格，露出接口（匹配九宫格活动）

<img src="https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20210728110939881.png" alt="image-20210728110939881" style="zoom:50%;" />

JSF接口：

入参：用户支付成功的原始订单号

出参： URL/Null(异常和未匹配成功均返回Null)

具体流程如下：

>1.根据原父订单号去查询订单中间件获取订单信息，传入OrderRequestDTO
>
>2.根据用户名和收货地址做前置校验
>
>3.从本地缓存中根据派发渠道(九宫格)筛选活动相关活动
>
>* 本地缓存对被动派发活动进行分类，提前筛选出特定类型活动用于 特色业务（九宫格/虚拟商品等）
>
>* 本地缓存变量增加一个Map<String, Map<Long, List<Activity>>>变量 用于存放后续特色业务筛选活动
>
>  String Key值为后期的业务分类（派发渠道[sendChannel]，商品类型[commodityType]）
>
>  里面的Map是 具体业务分类里的枚举类做key，相应的活动列表做Value.
>
>* 本地缓存筛选活动方式沿用同仓/专仓按仓维度筛选方式，先比较版本号，版本号小于远端版本号则从远端拉缓存至本地。
>
>4.遍历业务活动列表进行匹配，匹配逻辑无变更，解决了一个原订单和九宫格订单先后到达同步锁的问题，后边讲述。
>
>5.匹配成功之后放置活动和pin的缓存关系（value值为用户提单相关信息，可避免多次去请求订单中间件，过期时间默认一天？），为后面用户在H5申领试用品做校验。
>
>6.正常完成返回值输出为九宫格URL和试用品活动号。

### 2.3 试用品系统前后端交互图

<img src="https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20210728114546279.png" alt="image-20210728114546279" style="zoom:50%;" />

这块是C端H5和试用品后端交互，整体思路是通过网关路由HTTP的方式。

入参：网关Cookie，活动号

出参：三种状态码

具体流程如下:

> 1.通过请求获取登录用户pin和活动号
>
> 2.做前置校验，包括用户今日是否匹配，pin和活动号的匹配关系（获取到提单信息），活动有效性
>
> 3.先进行库存扣减，其次进行提单操作。把pin和活动号的匹配关系删除掉，后台避免用户再次发起申领。
>
> 4.三种返回情况，领取成功，活动失败还有稍后重试。



设置缓存 活动和pin的映射关系 v001_activityPin4SummitOrder_${activityId}__${pin}

value:  用户下单需要信息  过期时间：5day?

### 2.4 提单接口

<img src="https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20210726151336092.png" alt="image-20210726151336092" style="zoom:67%;" />

提单接口剥离，将原专仓下单接口抽离为入参为商品信息和用户信息。

本次传入活动信息和用户信息，根据活动信息去获取商品信息。（注意 活动信息此次为活动中的活动）



### 2.5 试用品系统匹配多件问题

问题描述：原利用用户pin过滤同一用户，因没有锁的处理同时放置位置与校验位置中间有时间损耗，导致无法拦截同一时刻同一用户只能参与一次试用品活动的问题。

<img src="https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20210728164101626.png" alt="image-20210728164101626" style="zoom:50%;" />

使用分布式缓存Key:

![image-20210728163950766](https://raw.githubusercontent.com/ly1246621281/PicGo/main/img/image-20210728163950766.png)

### 2.6 黑名单设置

虽然前端未曾暴露接口，但是需维护成DB和数据库同时更新操作。（非强一致，后续不给该用户发送试用品）

黑名单缓存： v001_blackPin_pin  1   (0x1)

黑名单-DB：

| 字段           | 数据类型    | 描述              |
| -------------- | ----------- | ----------------- |
| id             | int         | 自增主键          |
| blackPin       | varchar(50) | 黑名单pin         |
| blackDayNumber | int         | 过期失效，day粒度 |
| createby       | varchar(50) | 创建人            |
| createdate     | timestamp   | 创建时间          |
| updateby       | varchar(50) | 更新人            |
| updatedate     | timestamp   | 更新时间          |
| deleted        | tinyint     | 是否删除          |

