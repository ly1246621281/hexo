---
categories:
  - UPMP
---
---
title:运营看板优化2.0
date:2021.01.25
tag:JAVA,Project
---

# 运营看板口径统一+性能优化技术方案

## 一.口径统一

1. 界面增加相关字段

> * 所有的下钻列表页增加“活动名称”列，此列展示活动对应的活动名称
>
> * 下钻页面增加派发效率
> * 小数保留修改（界面展示与下载）

2. 筛选条件修改
> * T+1 更新要求每日12点，需调整分表时间
> * 活动状态对活动中，暂停，完成SQL修改成统计周期内有过此状态。
> * 统计周期修改为实际开始时间和实际结束时间+60![image-20210128154920702](https://i.loli.net/2021/01/28/W82RQa1MzUGJ9cH.png)

3.核心指标修改

> * 总派发量，实际出库量。
>
>   - 数据侧推送每日活动粒度的派发量
>
> * 派发收入  send_income字段由原先定值合同金额修改为变值（出库件数*单价）。
>
>   - 数据侧推送每日活动粒度的派发收入
>
> * 成交用户数，成交新用户数：**单活动去重，活动之间不去重**
>
> * 计划派发总量 ， 每天计划派发数量*统计周期内实际派发天数
>
> * 
>   $$
>   派发效率 = ∑1...n[（单活动a单日派发效率 + 单活动b单日派发效率 + …)/活动个数]/统计周期
>   $$
>   
>* 进行中的活动数，统计的是总活动中==截止统计结束时间==还处于“派发中”状态的活动数。与筛选条件中有过进行中不一致。

4.实时界面修改

> * 未开始：结束时间大于查询时间点，并且活动状态是“已创建（待开启）”、“待开始（待派发）”的活动。
> * 进行中：  活动状态为“派发中”状态的活动。  
> * 预警：活动总计划派发量为创建活动时维护的总数量，派发天数为创建活动时维护的活动结束时间减去活动开始时间，按照小时折合成天数（精确到一位小数，四舍五入）计算，比如2个小时为0.1天；每天计划派发量若有小数则四舍五入取整。备注：若当天实际只派发了几个小时，当天派发数量肯定会低于每天计划派发数量，产生预警；还有在派发速度较快的情况下，派发效率基本都会大于1；

5.转化分析修改

> * 修改细节同上


## 二.性能优化

### 数据源方面

1. 分表

> 解决问题：
>
> 运营看板pin表每天8w左右递增，需要分表
>
> 

2. 分库

>解决问题：
>
>长时间SQL处理，数据库QPS升高，影响生产sql处理速度

### 代码方面

1.引用线程池。

* 在前端页面请求接口，查询按钮点击即并行发送多个请求接口，此处无需优化

* 在对比指标处，加入线程池，若对比指标有数据，效率提升。

  ![image-20210127204455247](https://i.loli.net/2021/01/27/AEp5rsztS3vQynk.png)

* 细化SQL 增加索引

## 三.解决上线安全漏洞问题-SQL注入

​	针对 运营看板下钻界面按列排序问题，之前设计是由前端输入动态列名，后端直接排序。

​	0容易引发SQL注入风险，修改为Mybatis静态判断是否按选定列排序

## 四.待确认项

* TODO: 计划派发总量怎么计算。
* 派发效率：单活动总出库数/计划派发总量？
* 实时统计，进行中的活动不包含暂停和顺延后的？
* 预警活动说明，不明确？
* 活动概况里的 进行中的活动是否剔除暂停和延后？
* 对于采销经理角色（目前无活动管理和统计信息查询权限）需要新增权限。
* 成交额展示增加 其他用户成交额。  是取消了嘛？

·    计划派发总量怎么计算。——

·      派发进度中计划派发总量=每日计划派发个数 * 统计周期时长；其中每日计划派发个数 = 活动信息中计划派发总量 / （计划结束日期-计划开始日期）。

·    派发效率：单活动总出库数/计划派发总量？

·    ![img](C:/Users/ZHANGK~1/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg) 

·    实时统计，进行中的活动不包含暂停和顺延后的？——按照prd描述，不包含暂停和顺延 

只统计当前为派发中的活动  需更改PRD@吴晶晶

·    预警活动说明，不明确？——不明确的点具体是什么？

​      预警活动为派发效率<1的活动

·    活动概况里的 进行中的活动是否剔除暂停和延后？——活动概况中的进行中活动不包含暂停和顺延状态

只统计当前为派发中的活动   需更改PRD@吴晶晶

·    对于采销经理角色（目前无活动管理和统计信息查询权限）需要新增权限。——此行内容非本次prd新增，可与一期prd对比

去掉此处权限管理，活动看板再考虑是否有权限设置   需更改PRD@吴晶晶

·    成交额展示增加 其他用户成交额。 是取消了嘛？——prd评审时，数据侧确认不会有其他用户场景，因而在prd中删除了其他用户

是取消了，不再考虑

## 五. 修改记录

1. 数据库修改

   > ```sql
   >   alter table board_activity add 
   >    real_end_time timestamp default  '0000-00-00 00:00:00' comment '实际派发结束时间'; 
   >   alter table board_activity add 
   >    real_start_time timestamp default  '0000-00-00 00:00:00' comment '实际派发开始时间'; 
   >   
   >   alter table board_activity add 
   >    send_efficiency decimal(10,4) default  '0.0' comment '当日派发效率'; 
   >   alter table board_activity modify 
   >    activity_days decimal(10,4) default  '0.0' comment '活动天数'; 
   > ```
   > '
   
   2.代码修改
   
   > 枚举类中：
   >
   > * OperatorTaskEnum 记录所有任务
   > * OperatorTaskContant 下钻详情公式记录以及公式对应的任务映射枚举类
   > * OperatorDetailEnum 记录和前端下钻排序列一一映射的枚举类。和OperatorTaskContant 配合找到执行任务
   > * OperatorQueryPointEnum 复用SQL的筛选条件枚举类，在任务里填充QueryParam参数

## 六.Sharding记录

SQL 不支持：

```sql
select count(*) as activityCount from (
select  activity_id,user_log_acct
from
board_activity_pin
where
<include refid="com.jd.y.upack.core.board.mapper.TargetCommonTransformDao.queryConditionForTrans"/>
and is_send_trial_sku = 1
<if test = 'queryParamBO.activityId != null'>
    and activity_id = #{queryParamBO.activityId}
</if>
)t
```

```sql
select sum(sendCount) as activityCount from (
select  activity_id,count(distinct user_log_acct) as sendCount
from
board_activity_pin
where
<include refid="com.jd.y.upack.core.board.mapper.TargetCommonTransformDao.queryConditionForTrans"/>
and is_send_trial_sku = 1
<if test = 'queryParamBO.activityId != null'>
    and activity_id = #{queryParamBO.activityId}
</if>
group by activity_id
)t
```

* Sql解析错误

  ![image-20210313163843041](https://i.loli.net/2021/03/13/E7ijQkrsGUnhTcy.png)

![image-20210310210957628](https://i.loli.net/2021/03/10/ztoD8rNUiQJkW5M.png)

![image-20210310211034835](https://i.loli.net/2021/03/10/XxAQa7i3HyLMlDd.png)

解决方式：

1. ![image-20210313163703032](https://i.loli.net/2021/03/13/cVe9JMUdQn2LP7W.png)

   ![image-20210313165211886](https://i.loli.net/2021/03/13/r3DkM4haAwcPvWz.png)

2. 按路由建去查询，然后汇总。

   > ```
   > protected Map<Integer, List<Integer>> groupActivityIds(List<Integer> activitys) {
   >     if (CollectionUtils.isNotEmpty(activitys)) {
   >         return activitys.stream().collect(Collectors.
   >                 groupingBy(t -> t % 8, Collectors.collectingAndThen(Collectors.toList(), Function.identity())));
   >     } else {
   >         return new HashMap<>();
   >     }
   > }
   > 
   > protected List<SendTrendPO> shardingRouteByActivityId(QueryParamBO statisticsQuery) {
   >     Map<Integer, List<Integer>> activityIdMap = groupActivityIds(statisticsQuery.getActivityIds());
   >     List<SendTrendPO> transformResults = Lists.newArrayList();
   >     for (List<Integer> activityIds : activityIdMap.values()) {
   >         List<SendTrendPO> transformResult = this.sqlProcess(statisticsQuery, activityIds);
   >         transformResults.addAll(transformResult);
   >     }
   >     return transformResults;
   > }
   > 
   > protected List<SendTrendPO> sqlProcess(QueryParamBO statisticsQuery, List<Integer> activityIds) {
   >     return null;
   > }
   > ```

* 多路由但无法汇总

  ![image-20210313164308078](https://i.loli.net/2021/03/13/CKdXkQ9U1LODbPH.png)

> 分析需求,是否有必要count distinct。其次可考虑按路由建一起分组，即group by activity_id,activity_dt

## 七.SQL代码记录

### 1.核心指标

* 下载

  ```sql
  select
  	o.activity_id as activityId,
  	a.`name` as activityName,
  	a.create_by as createBy,
  	c.code as commodityCode,
  	o.store_id as storeId,
  	o.dc_id as dcId,
  	count(o.id) as storeSendCount
  from
  	order_record o
  inner join activity a on
  	o.activity_id = a.id
  	and a.deleted = 0
  inner join commodity c on
  	a.id = c.activity_id
  where
  	stock_status = 4
  	and (o.update_time between DATE_FORMAT( '2020-09-15 14:33:56.0', '%Y-%m-%d') and DATE_FORMAT( '2021-03-13 14:33:56.0', '%Y-%m-%d'))
  	and a.id in ( 10187 , 10343 , 10345 , 10346 , 10347 , 10348 )
  group by
  	o.activity_id,
  	o.dc_id,
  	o.store_id;
  ```

  ```sql
  select
  	activity_id as activityId,
  	count(id) as storeSendAllTotal
  from
  	order_record
  where
  	stock_status = 4
  	and (update_time between DATE_FORMAT( '2020-09-15 14:33:56.0', '%Y-%m-%d') and DATE_FORMAT( '2021-03-13 14:33:56.0', '%Y-%m-%d'))
  	and activity_id in ( 10187 , 10343 , 10345 , 10346 , 10347 , 10348 )
  group by
  	activity_id;
  ```

2. 活动概况
  
     ```sql
     select COUNT(activity_id) as activityTotal, count(distinct trial_brand_code) as brandTotal, sum(is_alert) as activityAlertTotal, sum(is_delay) as activityDelayTotal, sum(is_new_brand) as newBrandTotal, sum(is_new_brand)/count(distinct trial_brand_code) as newBrandRatio
      FROM (
      SELECT activity_id, trial_brand_code, if(sum(is_alert)>0,1,0) as is_alert, if(sum(is_delay)>0,1,0) as is_delay, if(sum(is_new_brand)>0,1,0) as is_new_brand
      FROM board_activity
      WHERE send_type = 1 and activity_dt between date('2021-03-14 00:00:00.0') and date('2021-03-14 00:00:00.0') and activity_dt between date(start_time) and date_add(end_time, interval 60 day) group by activity_id )t;
     ```




趋势图

按周

```sql
explain 
select DATE_FORMAT(STR_TO_DATE(CONCAT(YEAR(activity_dt),weekofyear(activity_dt)-1,'Monday') , '%X %V %W %u'), '%Y-%m-%d') as startActivityDt , DATE_FORMAT(STR_TO_DATE(CONCAT(YEAR(activity_dt),weekofyear(activity_dt),'Sunday') , '%X %V %W %u'), '%Y-%m-%d') as endActivityDt , weekofyear(activity_dt) periodNumber , sum(real_send_count) as realSendCount , sum(send_income) as sendIncome , sum(send_efficiency)/count(send_efficiency) as sendRate
 FROM board_activity
 WHERE send_type = 1 and activity_dt between date('2020-12-17 11:31:52.0') and date('2021-03-16 11:31:52.0') and activity_dt between date(start_time) and date_add(end_time, interval 60 day) and activity_id in ( 10187 , 10343 , 10345 , 10346 , 10347 , 10348 ) and distribution_model = 0 group by periodNumber;

```

```sql
select STR_TO_DATE(CONCAT(YEAR(activity_dt),weekPeriodNum-1,'Monday') , '%X %V %W %u') as startActivityDt , STR_TO_DATE(CONCAT(YEAR(activity_dt),weekPeriodNum,'Sunday') , '%X %V %W %u') as endActivityDt , weekPeriodNum as periodNumber , activity_id as activityId, if(count(distinct user_log_acct)!=0,count(distinct user_log_acct),0) as 'sendUserCount'
 FROM board_activity_pin
 WHERE send_date between date('2020-12-17 11:31:52.0') and date('2021-03-16 11:31:52.0') and send_type = 1 and activity_dt between date('2020-12-17 11:31:52.0') and date('2021-03-16 11:31:52.0') and activity_dt between date(start_time) and date_add(end_time, interval 60 day) and activity_id in ( 10187 , 10343 , 10345 , 10346 , 10347 , 10348 ) and distribution_model = 0 and is_send_trial_sku = 1 group by activity_id,periodNumber;
```

3. 活动看板下载

   ```sql
        select
   	activity_dt,
   	activity_id,
   	activity_name,
   	distribution_model,
   	create_by,
   	trial_item_sku_id ,
   	trial_brand_code ,
   	trial_item_first_cate_name ,
   	trial_item_second_cate_name ,
   	trial_item_third_cate_name ,
   	send_type ,
   	activity_status ,
   	plan_send_count ,
   	real_send_count,
   	send_efficiency ,
   	send_income,
   	real_send_user_count,
   	sendCount,
   	-- sku相关 
   	browsersku, addsku, dealsku, pvSku, browserSku/sendCount as uvSkuRatio, addsku/browserSku as addUVSkuRatio, addsku/dealsku as addDealSkuRatio, dealsku/sendCount as dealSkuRatio, dealSkuCount, dealSkuPrice, dealSkuPrice/browsersku as skuUvPrice, dealSkuPrice/dealSku as skuDealUserValue, 
   	-- brand相关
   	 browserbrand, addbrand, dealbrand, pvBrand, browserbrand/sendCount as uvBrandRatio, addbrand/browserbrand as addUVBrandRatio, addbrand/dealbrand as addDealBrandRatio, dealbrand/sendCount as dealBrandRatio, dealBrandCount, dealBrandPrice, dealBrandPrice/browserbrand as brandUvPrice, dealBrandPrice/dealBrand as brandDealUserValue, 
   	 -- 新老用户相关 
   	 newDealUser, oldDealUser, awakenDealUser, newDealUser/dealbrand as newDealUserRatio, oldDealUser/dealbrand as oldDealUserRatio, awakenDealUser/dealbrand as awakenDealUserRatio, newDealCount, oldDealCount, awakenDealCount, newDealCount/dealBrandCount as newDealCountRatio, oldDealCount/dealBrandCount as awakenDealCountRatio, awakenDealCount/dealBrandCount as awakenDealCountRatio, newDealPrice, oldDealPrice, awakenDealPrice, newDealPrice/dealBrandPrice as newDealPriceRatio, oldDealPrice/dealBrandPrice as oldDealPriceRatio, awakenDealPrice/dealBrandPrice as awakenDealPriceRatio, newDealPrice/newDealUser as newUvValue, oldDealPrice/oldDealUser as oldUvValue, awakenDealPrice/awakenDealUser as awakenUvValue
   
   	from (
   	select
   		a.activity_dt, a.activity_id, a.activity_name, a.distribution_model, a.create_by, a.trial_item_sku_id, a.trial_brand_code , a.trial_item_first_cate_name , a.trial_item_second_cate_name , a.trial_item_third_cate_name , a.send_type , a.activity_status , a.plan_send_count_day as plan_send_count , a.real_send_count, a.send_efficiency , a.send_income, a.real_send_user_count, real_send_user_count as sendCount,
   		-- sku维度 
   		sum(is_browser_target_sku) as browserSku, sum(is_add_cart_target_sku) as addSku, sum(is_deal_target_sku) as dealSku, sum(browser_target_sku_num) as pvSku, sum(target_sku_sale_qtty) as dealSkuCount, sum(target_sku_amount) as dealSkuPrice, 
   		-- brand维度 
   		sum(is_browser_target_brand) as browserbrand, sum(is_add_cart_target_brand) as addbrand, sum(is_deal_target_brand) as dealbrand, sum(browser_target_brand_num) as pvBrand, sum(target_brand_sale_qtty) as dealBrandCount, sum(target_brand_amount) as dealBrandPrice, 
   		-- 新老客维度 
   		sum(if(user_type = 3 and is_deal_target_brand = 1, 1 ,0)) as newDealUser, sum(if(user_type = 2 and is_deal_target_brand = 1, 1 ,0)) as oldDealUser, sum(if(user_type = 1 and is_deal_target_brand = 1, 1 ,0)) as awakenDealUser, sum(if(user_type = 3 and is_deal_target_brand = 1, target_brand_sale_qtty ,0)) as newDealCount, sum(if(user_type = 2 and is_deal_target_brand = 1, target_brand_sale_qtty ,0)) as oldDealCount, sum(if(user_type = 1 and is_deal_target_brand = 1, target_brand_sale_qtty ,0)) as awakenDealCount, sum(if(user_type = 3 and is_deal_target_brand = 1, target_brand_amount ,0)) as newDealPrice, sum(if(user_type = 2 and is_deal_target_brand = 1, target_brand_amount ,0)) as oldDealPrice, sum(if(user_type = 1 and is_deal_target_brand = 1, target_brand_amount ,0)) as awakenDealPrice
   
   		from board_activity a
   	left join board_activity_pin b on
   		a.activity_id = b.activity_id
   		and a.activity_dt = b.activity_dt
   	where
   		a.activity_dt between date('2021-01-03 17:03:44.0') and date('2021-04-05 17:03:44.0')
   		and a.activity_id = 10343
   	group by
   		a.activity_dt ) t;
   ```

   

## 八.上线准备

1.DB

> push-table:
>
> ```sql
> -- upmp2_2.board_push_data_finish definition
> 
> CREATE TABLE `board_push_data_finish` (
>   `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
>   `table_name` varchar(100) DEFAULT NULL COMMENT '表名',
>   `dt` varchar(16) DEFAULT NULL COMMENT '分区时间',
>   `modify_time` datetime DEFAULT NULL COMMENT '记录更新时间',
>   `sharding_end_time` datetime DEFAULT NULL COMMENT '分表结束时间',
>   PRIMARY KEY (`id`),
>   KEY `idx_table_name` (`table_name`)
> ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='大数据推送数据任务结束记录表';
> ```
>

2. 原Important.properties

```
config.db.url=qCx3UZJP7NrJy0JGgUGdapzQcojzITi4rjf+mzU8MKzS7d5chqK1588IfpkDy1/c+IgykLZXLC2ZiTI2n56PY/6EnGlQALGxRvH84WKWzA3f8bLE9Kj9PCV+qjlbB/YWnvcakd6OFTjLXE0ITtWEE2oqV/m+MbvR+9IhJYcWCJ0XlaSrRRaP0mT4o2opoItx99dOvKSLuaQ=
config.db.user=DpyhJf6LgXhxG0Wx52vT0g==
config.db.password=QbdACsHDu8N6vyVWCVfKZgn6/P7zKw80B+mvpzTreIaIX3WASTQZ2g==
```

3. 上线版本 Important.properties

   ```
   config.dynamic.datasource.db.url=qCx3UZJP7NrJy0JGgUGdapzQcojzITi4rjf+mzU8MKzS7d5chqK1588IfpkDy1/c+IgykLZXLC2ZiTI2n56PY/6EnGlQALGxRvH84WKWzA3f8bLE9Kj9PCV+qjlbB/YWnvcakd6OFTjLXE0ITtWEE2oqV/m+MbvR+9IhJYcWCJ0XlaSrRRaP0mT4o2opoItx99dOvKSLuaQ=
   config.dynamic.datasource.db.username=DpyhJf6LgXhxG0Wx52vT0g==
   config.dynamic.datasource.db.password=QbdACsHDu8N6vyVWCVfKZgn6/P7zKw80B+mvpzTreIaIX3WASTQZ2g==
   config.dynamic.datasource.db2.url=qCx3UZJP7NrJy0JGgUGdai7c0b0b94aFrjf+mzU8MKzS7d5chqK155sluPIDxt40IdlecjHkp3c879DmniXhoENB+Y3cXBNRRk6o8cGVIBzV/+NVikmhPfJL2mTPV3i1LkBL93WSK0HifTOMPVCtBWLs3O7Sr/M5+ZeEo/apxHgGfsB7nFTYg+pKTLoFChI7Mp8h7L4rZyM=
   config.dynamic.datasource.db2.username=UXuh4jNyIJtTrCkF/OKQzQ==
   config.dynamic.datasource.db2.password=NFSo7ao35/KpnWFnEJMe1RvurQ21tcJFe82bhm95+iOIX3WASTQZ2g==
   config.dynamic.datasource.db2-slave0.url=qCx3UZJP7NrJy0JGgUGdaow9QH61TqSh2MwGb2YH/gy2ndCV5iounYlh2jUz2zsMaHn9XNamaElAzn1xZ4O4/bY9PfjIrnRMrXmJZZHwyIsp9Op4ROWSPVi5HFzJN+H0J5P2tBg0fU/qou/64h4GGxjTGLXhzn9/8Q694NsuvTMKpV2fc0/BQFWiyP+x/SfCk6lNiz9xPho=
   config.dynamic.datasource.db2-slave0.username=UXuh4jNyIJtTrCkF/OKQzQ==
   config.dynamic.datasource.db2-slave0.password=NFSo7ao35/KpnWFnEJMe1RvurQ21tcJFe82bhm95+iOIX3WASTQZ2g==
   config.dynamic.datasource.db2-slave1.url=qCx3UZJP7NrJy0JGgUGdaroPSdhXq/od2MwGb2YH/gy2ndCV5iounYlh2jUz2zsMaHn9XNamaElAzn1xZ4O4/bY9PfjIrnRMrXmJZZHwyIsp9Op4ROWSPVi5HFzJN+H0J5P2tBg0fU/qou/64h4GGxjTGLXhzn9/8Q694NsuvTMKpV2fc0/BQFWiyP+x/SfCk6lNiz9xPho=
   config.dynamic.datasource.db2-slave1.username=UXuh4jNyIJtTrCkF/OKQzQ==
   config.dynamic.datasource.db2-slave1.password=NFSo7ao35/KpnWFnEJMe1RvurQ21tcJFe82bhm95+iOIX3WASTQZ2g==
   ```
   
   4.  预发环境
   
      ```
      config.dynamic.datasource.db.url=qCx3UZJP7NoCgsWMq5VKVjk0NH3rSg0n6XN1mQiXskjGCZKAIER/Blpk0/pRZYS45Kl0yHhYXukKkbnqVCkMUKc+Z4Vkj5I1EX2/xcPCk8D/gxtHon/g/LBNuGqq7WpJF69LJ+L6HJvTlGfQndy68MtxDpwV4wxIXn7uLEBWfn/dpb185O9MyQcSg/m1FQXv4Py/iRS1xqU=
      config.dynamic.datasource.db.username=bF7W/r38nAW/pc2XeBPWLA==
      config.dynamic.datasource.db.password=LQuDj75IKIzsX6Xh85KXyYhfdYBJNBna
      config.dynamic.datasource.db2.username=UXuh4jNyIJs2nYplsM/iIv7nWEU0EWwz
      config.dynamic.datasource.db2.password=mZ14PvmtWY3s44ytD4+fBIhfdYBJNBna
      config.dynamic.datasource.db2.url=qCx3UZJP7NoCgsWMq5VKVk+KtLZBXBRofx+eQ3cdz7+YNz6aUfcUneBwwDmwmW7m+qXfOLcNSG/d+6BhD+ead7za8+38voCOrPiyrYzOudFyOW08FUYI29UchJK82b5btY5xVNPonGpSA3p9zucqI39DlZ+rpn0mskgkMN5lb0TnLcvtIraWtBddG7tshONr54wo4w73WEuIX3WASTQZ2g==
      config.dynamic.datasource.db2-slave0.username=UXuh4jNyIJs2nYplsM/iIv7nWEU0EWwz
      config.dynamic.datasource.db2-slave0.password=mZ14PvmtWY3s44ytD4+fBIhfdYBJNBna
      config.dynamic.datasource.db2-slave0.url=qCx3UZJP7NoCgsWMq5VKVk+KtLZBXBRofx+eQ3cdz7+YNz6aUfcUneBwwDmwmW7m+qXfOLcNSG/d+6BhD+ead7za8+38voCOrPiyrYzOudFyOW08FUYI29UchJK82b5btY5xVNPonGpSA3p9zucqI39DlZ+rpn0mskgkMN5lb0TnLcvtIraWtBddG7tshONr54wo4w73WEuIX3WASTQZ2g==
      config.dynamic.datasource.db2-slave1.username=UXuh4jNyIJs2nYplsM/iIv7nWEU0EWwz
      config.dynamic.datasource.db2-slave1.password=mZ14PvmtWY3s44ytD4+fBIhfdYBJNBna
      config.dynamic.datasource.db2-slave1.url=qCx3UZJP7NoCgsWMq5VKVk+KtLZBXBRofx+eQ3cdz7+YNz6aUfcUneBwwDmwmW7m+qXfOLcNSG/d+6BhD+ead7za8+38voCOrPiyrYzOudFyOW08FUYI29UchJK82b5btY5xVNPonGpSA3p9zucqI39DlZ+rpn0mskgkMN5lb0TnLcvtIraWtBddG7tshONr54wo4w73WEuIX3WASTQZ2g==
      ```
   
      


##  九. 性能优化

### 1.业务优化

1. 总数据量   --  8665340（2021-01-01 -- 2021-03-29）

2. 派发无用数据总量

   试用品量级 -- 3892915

   话卡量级 -- 4772425

3. 派发无用数据 -- 5586342  其中试用品 1652782，话卡3933560

   | 2021.01.01-2021.03.29 | 总量    | 派发数据 | 转化数据 | 修改后可减少数据比率 |
   | --------------------- | ------- | -------- | -------- | -------------------- |
   | 汇总                  | 8665340 | 5589342  | 3078998  | 64%                  |
   | 试用品                | 3892915 | 1652782  | 2240133  | 42%                  |
   | 话卡                  | 4772425 | 3933560  | 838865   | 82%                  |
   | 预估一年              | 2700w   | 1600w    | 1100w    | 60%                  |

### 2.索引优化

   ```sql
   -- 加购用户
   explain
   select
   	activity_id ,
   	count(user_log_acct)
   from
   	board_activity_pin
   where
   -- send_date between date('2021-01-01 21:05:29.0') and date('2021-03-29 21:05:29.0')
   -- and 
   	activity_id in ( 10030 , 10034 , 10039 , 10052 , 10055 , 10058 , 10059 , 10060 , 10062 , 10063 , 10066 , 10105 , 10151 , 10152 , 10153 , 10155 , 10156 , 10157 , 10158 , 10159 , 10160 , 10187 , 10191 , 10193 , 10195 , 10200 , 10208 , 10212 , 10214 , 10219 , 10222 , 10239 , 10241 , 10242 , 10246 , 10248 , 10249 , 10250 , 10252 , 10253 , 10254 , 10255 , 10261 , 10262 , 10283 , 10284 , 10286 , 10294 , 10295 , 10297 , 10298 , 10299 , 10300 , 10314 , 10317 , 10318 , 10319 , 10320 , 10321 , 10327 , 10328 , 10331 , 10337 , 10339 , 10341 , 10343 , 10345 , 10346 , 10347 , 10348 , 10350 , 10354 , 10364 , 10365 , 10366 , 10367 , 10368 , 10369 , 10370 , 10371 , 10379 , 10389 , 10392 , 10394 , 10398 , 10402 , 10403 , 10405 , 10407 , 10408 , 10409 , 10418 , 10419 , 10420 , 10424 , 10425 , 10426 , 10428 , 10429 , 10430 , 10431 , 10434 , 10436 , 10437 , 10438 , 10439 , 10440 , 10441 , 10442 , 10444 , 10445 , 10446 , 10450 , 10451 , 10452 , 10454 , 10465 , 10466 , 10468 , 10469 , 10471 , 10472 , 10473 , 10474 , 10475 , 10486 , 10516 , 10525 , 10554 , 10555 , 10570 , 10599 , 10605 , 10615 , 10667 , 10668 , 10679 , 10680 , 10681 , 10705 , 10706 , 10707 , 10744 , 10748 , 10793 , 10806 , 10826 , 10832 , 10861 , 10873 , 10874 , 10885 , 10886 , 10887 , 10888 , 10889 , 10895 , 10896 , 10906 , 10907 , 10908 , 10909 , 10912 , 10922 , 10924 , 10925 , 10929 , 10937 , 10938 , 10964 , 10966 , 10973 , 10974 , 10976 , 10977 , 10978 , 10980 , 10981 , 10983 , 10985 , 10991 , 10992 , 10993 , 10997 , 10999 , 11000 , 11001 , 11008 , 11009 , 11011 , 11012 , 11013 , 11014 , 11017 , 11019 , 11020 , 11021 , 11023 , 11025 , 11026 , 11027 , 11032 , 11034 , 11052 , 11054 , 11056 , 11057 , 11058 , 11065 , 11068 , 11069 , 11072 , 11075 , 11078 , 11082 , 11085 , 11086 , 11089 , 11090 , 11092 , 11094 , 11096 , 11097 , 11098 , 11099 , 11100 , 11101 , 11102 , 11103 , 11104 , 11105 , 11106 , 11107 , 11108 , 11112 , 11114 , 11115 , 11116 , 11117 , 11120 , 11125 , 11130 , 11132 , 11133 , 11144 , 11147 , 11151 , 11154 , 11155 , 11156 , 11158 , 11162 , 11166 , 11167 , 11168 )
   
   and activity_dt between date('2021-01-01 21:05:29.0') and date('2021-03-29 21:05:29.0')
   -- and activity_dt between date(start_time) and date_add(end_time, interval 60 day)
   -- and is_browser_target_brand = 1
   -- and is_add_cart_target_brand = 1
   -- and is_add_cart_target_sku = 1
   and is_browser_target_sku = 1
   group by
   	activity_id;
   ```

   建立如下索引，没走，效率巨慢有10s+

```sqlite
alter table board_activity_pin add index idx_browser_sku(activity_id,activity_dt,start_time,end_time,user_log_acct,is_browser_target_sku);
```

建立如下索引，走索引，有1.78s

```sql
alter table board_activity_pin add index idx_browser_sku(activity_id,user_log_acct,is_browser_target_sku,activity_dt,start_time,end_time);
```

建立如下索引，走索引，有600ms

```sql
alter table board_activity_pin add index idx_browser_sku(activity_id,is_browser_target_sku,user_log_acct,activity_dt,start_time,end_time);
```

建立如下索引，不走索引

```sql
alter table board_activity_pin add index idx_browser_sku(activity_id,is_browser_target_sku,activity_dt,start_time,end_time,user_log_acct);
```

**索引优化后续：** 

1.和数据量，数据区别度有关。

```sql
alter table board_activity_pin add index idx_browser_sku(is_browser_target_sku,activity_id,activity_dt,user_log_acct);
```

2.后续发现300w的量在内存里count( distinct  user_log_acct )

发现explain不走range，走的是ref -->const,是DB选择了最优方式，但还是效率不行。==最后选择业务切片，缩小数据量==。



**说明：**

1. 最左前缀匹配原则，非常重要的原则，

- mysql会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，
- 比如a = 1 and b = 2 and c > 3 and d = 4
  - 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，
  - 如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整（建立索引时他们三个的顺序）

如上，activity_dt必须建立在后面，影响索引使用长度

2. user_log_acct计算字段其实不走索引，只是在索引中把该字段计算了一遍，因此位置应后置

3. start_time,end_time 理论上不走索引的，因为前置有函数。

4. 最后和数据侧从业务上排查，start_time无需使用筛选，数据侧保证。150ms出结果。

   ```sql
   alter table board_activity_pin add index idx_browser_sku(activity_id,is_browser_target_sku,activity_dt,user_log_acct);
   ```

**补充：**

#### 建索引的几大原则

- 1.最左前缀匹配原则，非常重要的原则，
  - mysql会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，
  - 比如a = 1 and b = 2 and c > 3 and d = 4
    - 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，
    - 如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整（建立索引时他们三个的顺序）
- 2.=和in可以乱序，
  - 比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引**可以任意顺序**，
  - mysql的查询优化器会帮你优化成索引可以识别的形式。
- 3.尽量选择区分度高的列作为索引，
  - 区分度的公式是count(distinct col)/count(*)，表示字段不重复的比例，
    - 比例越大我们扫描的记录数越少，唯一键的区分度是1，
    - 而一些状态、性别字段可能在大数据面前区分度就是0，
    - 那可能有人会问，这个比例有什么经验值吗？
      - 使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是0.1以上，即平均1条扫描10条记录。
- 4.**索引列不能参与计算，保持列“干净”**，
  - 比如from_unixtime(create_time) = ’2014-05-29’就不能使用到索引，
  - 原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都**应用函数才能比较，显然成本太大**。
    - 所以语句应该写成create_time = unix_timestamp(’2014-05-29’)
- 5.尽量的扩展索引，不要新建索引。
  - 比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。

[https://tech.meituan.com/2014/06/30/mysql-index.html](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Ftech.meituan.com%2F2014%2F06%2F30%2Fmysql-index.html)   

### 3. 线程池使用 

```java
public class AsyncTaskUtil {

    private ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat("async-task-util-%d")
            .build();

    private ExecutorService executorService = new ThreadPoolExecutor(30, 540, 0,
            TimeUnit.SECONDS, new LinkedBlockingQueue<>(1000),
            threadFactory);

    public <T> List<T> executeTaskList(List<Callable<T>> taskList, long taskTimeOutSecs) {
        List<Future<T>> futures = Lists.newArrayList();
        try {
            List<T> resList = Lists.newArrayList();

            int taskSize = taskList.size();
            for (Callable<T> tCallable : taskList) {
                Future<T> future = executorService.submit(tCallable);
                futures.add(future);
            }

            for (int i = 0; i < taskSize; i++) {
                T res = futures.get(i).get(taskTimeOutSecs, TimeUnit.SECONDS);
                resList.add(res);
            }

            return resList;

        } catch (Exception e) {
            log.error("执行异步任务失败", e);
            return null;
        } finally {
            for (Future f : futures) {
                f.cancel(true);
            }
        }
    }
}
```

1.  List<Future<T>> futures 保证顺序，以最后一个任务时间未结束时间。

2. ```
   class StatExecutor implements Callable
   用好构造函数，但需保证无公用属性。多线程大忌。
   ```

3.  子线程中可再起 子线程，但需注意传递属性时不能使用父类公用属性，后期就变量值错乱。

   注意静态对象和单例对象。

## 十. 线上问题总结

#### 1.hikari线程池

最小空闲数设置为100，最大为300。导致报错too many connect、

hikari官方文档不建议设置最小空闲数，默认和最大线程数相同，同时默认为10个。

最大线程数也不是设置越多越好，受限于磁盘IO，网络带宽限制。默认core*2+1.

[about pool size](https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing)

动态数据源时，默认连接的是主库数据源的连接，由下图连接数可得。

#### 2.mysql 最大連接數

当天几台服务器没起来，查看当时max connect，db1-- 2000  db2--2700

```sql
show global status like 'Max_used_connections';

show variables like '%max_connections%';
show status like 'Threads%';  
   mysql> show status like 'Threads%';  
    +-------------------+-------+  
    | Variable_name     | Value |  
    +-------------------+-------+  
    | Threads_cached    | 58    |  
    | Threads_connected | 57    |   ###这个数值指的是打开的连接数  
    | Threads_created   | 3676  |  
    | Threads_running   | 4     |   ###这个数值指的是激活的连接数，这个数值一般远低于connected数值  
SHOW STATUS LIKE '%Connection%'; 
```

上线当晚，DB1默认数据库启动了连接数10000+，导致部分机器连接数据库失败。

![image-20210418192158145](https://i.loli.net/2021/04/18/DrHQSzhmgnaXbEx.png)

当晚2.38机器更新最小配置数，恢复正常。

![image-20210418192416127](https://i.loli.net/2021/04/18/2MsdqVc74yaIvzx.png)

记录1.40刻，db1--10000  db2--4000 db2-s1 2400 db2-s2 2700 (后续仍需关注启动连接数)

查看可得db2目前已恢复平均600左右。（max-connect达到5701，后续仍需关注）

目前db1 恢复在1500左右。

#### 3. TCP连接数

一台机器最大究竟能支持多少个网络连接？这个简单的问题里其实埋了坑，导致无数的英雄好汉被困惑不解。就和树上九只鸟打死一只还剩几只的问题一样，没有和你说清楚树上是真鸟，还是假鸟。也没有说枪是有声还是无声的。通过今天的分析，相信你终于可以扬眉吐气把这个问题踩在脚下摩擦了。

TCP连接的客户端机：每一个ip可建立的TCP连接理论受限于ip_local_port_range参数，也受限于65535（端口号）。但可以通过配置多ip的方式来加大自己的建立连接的能力（一个网卡可能多个ip）。
TCP连接的服务器机：每一个监听的端口虽然理论值很大，但这个数字没有实际意义。最大并发数取决你的内存大小，每一条静止状态的TCP连接大约需要吃3 .3K的内存（与内存有关）。
————————————————
版权声明：本文为CSDN博主「zhangyanfei01」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/zhangyanfei01/article/details/110622360