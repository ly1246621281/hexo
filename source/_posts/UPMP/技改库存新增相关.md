---
categories:
  - UPMP
---
# 技改库存新增相关

## 1. 调整库存

* 封装库存按SKU.仓库模式查询接口DataResponse<List<WarehouseDistDTO>> getAllStoreStockInfoListBySku(Long sku, WarehouseType warehouseType);

  > 1.调用方： 开启专仓活动+调整专仓库存
  >
  > 过滤仓库列表ActivityServiceImpl   filterStock(List<StockBO> stocks, CommodityPO commodityPO)
  >
  > 2.完全查数据库？
  
* 封装同仓活动加锁，解锁接口

  ```java
  DataResponse lockCommonWarehouseStock(String user, UpdateWarehouseDTO updateWarehouseDTO);
  
  DataResponse unlockCommonWarehouseStock(String user, UpdateWarehouseDTO updateWarehouseDTO);
  ```

  > 1.调用方： StockServiceImpl + StockRepaireJob
  >
  > 代替  doUnLockStock
  >
  > 代替  doReLockStock+
  >
  > 2.是否需要移除缓存里锁定的库存？ 解锁没有动DB库存，加锁有对更新的、插入的、删除的做DB库存操作。
  >
  > -- 解锁移除缓存，加锁增加缓存？

  

## 2.库存扣减/后续持久化/回滚

* 修改库存扣减接口，移除扣减完持久化后续存储代码

> 上一版本代码是扣减成功后立马做后续持久化，于逻辑上不正确。此次增加工作量进行调整。
>
> 修改接口名为：**orderStockServiceJsf**

* 封装 订单匹配后，库存扣减接口(封装 单仓扣减逻辑)

```java
public DataResponse orderStockReduce(OrderRequestDTO orderRequestDTO, ActivityDTO activityDTO) 
```

* 封装 库存扣减成功后，业务校验通过后后续持久化
```java
  public DataResponse orderStockPersist(OrderRequestDTO orderRequestDTO, ActivityDTO activityDTO)
```

* 封装 库存扣减成功后，业务校验失败后回滚接口

```java
public DataResponse orderStockRevert(OrderRequestDTO orderRequestDTO, ActivityDTO activityDTO) 
```



## 3.虚拟品扣减库存支持

虚拟品保存活动时需放库存缓存 以及 数据库插入库存记录。

* 新增虚拟品库存设置方法： 在接口ActivityWarehouseStockService

```java
DataResponse setActivityWarehouseDist(WarehouseDistDTO warehouseDistDTO, String user);
```

